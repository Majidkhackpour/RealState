IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Cities_States]') AND parent_object_id = OBJECT_ID(N'[dbo].[Cities]'))
ALTER TABLE [dbo].[Cities]  WITH CHECK ADD  CONSTRAINT [FK_Cities_States] FOREIGN KEY([StateGuid])
REFERENCES [dbo].[States] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Regions_States]') AND parent_object_id = OBJECT_ID(N'[dbo].[Regions]'))
ALTER TABLE [dbo].[Regions]  WITH CHECK ADD  CONSTRAINT [FK_Regions_States] FOREIGN KEY([CityGuid])
REFERENCES [dbo].[Cities] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Buildings_Peoples]') AND parent_object_id = OBJECT_ID(N'[dbo].[Buildings]'))
ALTER TABLE [dbo].[Buildings]  WITH CHECK ADD  CONSTRAINT [FK_Buildings_Peoples] FOREIGN KEY([OwnerGuid])
REFERENCES [dbo].[Peoples] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Buildings_Users]') AND parent_object_id = OBJECT_ID(N'[dbo].[Buildings]'))
ALTER TABLE [dbo].[Buildings]  WITH CHECK ADD  CONSTRAINT [FK_Buildings_Users] FOREIGN KEY([UserGuid])
REFERENCES [dbo].[Users] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Buildings_Cities]') AND parent_object_id = OBJECT_ID(N'[dbo].[Buildings]'))
ALTER TABLE [dbo].[Buildings]  WITH CHECK ADD  CONSTRAINT [FK_Buildings_Cities] FOREIGN KEY([CityGuid])
REFERENCES [dbo].[Cities] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Buildings_Regions]') AND parent_object_id = OBJECT_ID(N'[dbo].[Buildings]'))
ALTER TABLE [dbo].[Buildings]  WITH CHECK ADD  CONSTRAINT [FK_Buildings_Regions] FOREIGN KEY([RegionGuid])
REFERENCES [dbo].[Regions] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Buildings_BuildingType]') AND parent_object_id = OBJECT_ID(N'[dbo].[Buildings]'))
ALTER TABLE [dbo].[Buildings]  WITH CHECK ADD  CONSTRAINT [FK_Buildings_BuildingType] FOREIGN KEY([BuildingTypeGuid])
REFERENCES [dbo].[BuildingTypes] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Buildings_BuildingAccountType]') AND parent_object_id = OBJECT_ID(N'[dbo].[Buildings]'))
ALTER TABLE [dbo].[Buildings]  WITH CHECK ADD  CONSTRAINT [FK_Buildings_BuildingAccountType] FOREIGN KEY([BuildingAccountTypeGuid])
REFERENCES [dbo].[BuildingAccountTypes] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Buildings_BuildingView]') AND parent_object_id = OBJECT_ID(N'[dbo].[Buildings]'))
ALTER TABLE [dbo].[Buildings]  WITH CHECK ADD  CONSTRAINT [FK_Buildings_BuildingView] FOREIGN KEY([BuildingViewGuid])
REFERENCES [dbo].[BuildingViews] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Buildings_FloorCover]') AND parent_object_id = OBJECT_ID(N'[dbo].[Buildings]'))
ALTER TABLE [dbo].[Buildings]  WITH CHECK ADD  CONSTRAINT [FK_Buildings_FloorCover] FOREIGN KEY([FloorCoverGuid])
REFERENCES [dbo].[FloorCovers] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Buildings_KitchenService]') AND parent_object_id = OBJECT_ID(N'[dbo].[Buildings]'))
ALTER TABLE [dbo].[Buildings]  WITH CHECK ADD  CONSTRAINT [FK_Buildings_KitchenService] FOREIGN KEY([KitchenServiceGuid])
REFERENCES [dbo].[KitchenServices] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_BuildingsReq_Asker]') AND parent_object_id = OBJECT_ID(N'[dbo].[BuildingRequests]'))
ALTER TABLE [dbo].[BuildingRequests]  WITH CHECK ADD  CONSTRAINT [FK_BuildingsReq_Asker] FOREIGN KEY([AskerGuid])
REFERENCES [dbo].[Peoples] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_UserLog_User]') AND parent_object_id = OBJECT_ID(N'[dbo].[UserLogs]'))
ALTER TABLE [dbo].[UserLogs]  WITH CHECK ADD  CONSTRAINT [FK_UserLog_User] FOREIGN KEY([UserGuid])
REFERENCES [dbo].[Users] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_Note_User]') AND parent_object_id = OBJECT_ID(N'[dbo].[Notes]'))
ALTER TABLE [dbo].[Notes]  WITH CHECK ADD  CONSTRAINT [FK_Note_User] FOREIGN KEY([UserGuid])
REFERENCES [dbo].[Users] ([Guid])
GO

IF NOT EXISTS (SELECT * FROM sys.foreign_keys WHERE object_id = OBJECT_ID(N'[dbo].[FK_SmsLog_User]') AND parent_object_id = OBJECT_ID(N'[dbo].[SmsLogs]'))
ALTER TABLE [dbo].[SmsLogs]  WITH CHECK ADD  CONSTRAINT [FK_SmsLog_User] FOREIGN KEY([UserGuid])
REFERENCES [dbo].[Users] ([Guid])
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Cities_SelectAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Cities_SelectAll]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_Cities_SelectAll] 
AS
BEGIN
	select Cities.*,States.Name As StateName
	from Cities inner join States 
	on Cities.StateGuid=States.Guid
	order by StateName, Cities.Name
END
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Regions_SelectAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Regions_SelectAll]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_Regions_SelectAll] 
AS
BEGIN
	select Regions.*,Cities.Name As CityName,States.Name As StateName
	from Regions left outer join Cities on Regions.CityGuid=Cities.Guid
	inner join States on Cities.StateGuid=States.Guid
	order by StateName,CityName
END
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Regions_SelectAllByCityGuid]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Regions_SelectAllByCityGuid]	As Begin print 11 end')
GO
ALTER PROCEDURE [dbo].[sp_Regions_SelectAllByCityGuid] 
	@cityGuid uniqueidentifier
AS
BEGIN
	select Regions.*,Cities.Name As CityName,States.Name As StateName
	from Regions inner join Cities on Regions.CityGuid=Cities.Guid
	inner join States on Cities.StateGuid=States.Guid
	where Regions.CityGuid=@cityGuid
	order by StateName,CityName
END
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Cities_SelectAllByStateGuid]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Cities_SelectAllByStateGuid]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_Cities_SelectAllByStateGuid] 
	@stateGuid uniqueidentifier
AS
BEGIN
	select Cities.*,States.Name As StateName
	from Cities inner join States 
	on Cities.StateGuid=States.Guid
	where Cities.StateGuid=@stateGuid
	order by StateName, Cities.Name
END
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Buildings_SelectAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Buildings_SelectAll]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_Buildings_SelectAll] 
AS
BEGIN
select [dbo].[Buildings].*,[dbo].[Peoples].Name As OwnerName,
       [dbo].[BuildingTypes].Name As BuildingTypeName,
	   [dbo].[Users].Name As UserName,
	   [dbo].[Regions].Name As RegionName,
	   [dbo].[RentalAuthorities].Name As RentalAuthorityName
From [dbo].[Buildings] 
     inner join [dbo].[Peoples] on [dbo].[Buildings].OwnerGuid=[dbo].[Peoples].Guid
	 inner join [dbo].[BuildingTypes] on [dbo].[Buildings].BuildingTypeGuid=[dbo].[BuildingTypes].Guid
	 inner join [dbo].[Users] on [dbo].[Buildings].UserGuid=[dbo].[Users].Guid
	 inner join [dbo].[Regions] on [dbo].[Buildings].RegionGuid=[dbo].[Regions].Guid
	 left outer join [dbo].[RentalAuthorities] on [dbo].[Buildings].RentalAutorityGuid=[dbo].[RentalAuthorities].Guid
End
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_BuildingsReq_SelectAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_BuildingsReq_SelectAll]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_BuildingsReq_SelectAll] 
AS
BEGIN
select [dbo].[BuildingRequests].*,[dbo].[Peoples].Name As AskerName,
	   [dbo].[Users].Name As UserName
	   From [dbo].[BuildingRequests] 
	   inner join [dbo].[Peoples] on [dbo].[BuildingRequests].AskerGuid=[dbo].[Peoples].Guid
	   inner join [dbo].[Users] on [dbo].[BuildingRequests].UserGuid=[dbo].[Users].Guid
End
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Contract_SelectAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Contract_SelectAll]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_Contract_SelectAll] 
AS
BEGIN
	select [dbo].[Contracts].*,[dbo].[Peoples].Name as fName,
	(select [dbo].[Peoples].Name from [dbo].[Peoples] where Guid=[dbo].[Contracts].SecondSideGuid) as sName,
	[dbo].[Users].Name as UserName
	from [dbo].[Contracts] left Outer join [dbo].[Peoples]
	on [dbo].[Contracts].FirstSideGuid=[dbo].[Peoples].Guid
	left outer join [dbo].[Users]
	on [dbo].[Contracts].UserGuid=[dbo].[Users].Guid
End
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_UserLog_SelectAll_ByUser_And_Date]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_UserLog_SelectAll_ByUser_And_Date]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_UserLog_SelectAll_ByUser_And_Date] 
	@userGuid uniqueidentifier,
	@date1 datetime,
	@date2 datetime
AS
BEGIN
	select [dbo].[UserLogs].*,[dbo].[Users].Name as UserName
	from [dbo].[UserLogs] inner join [dbo].[Users]
	on [dbo].[UserLogs].UserGuid=[dbo].[Users].Guid
	where Date>=@date1 and Date<=@date2 and UserGuid=@userGuid
End
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Note_SelectAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Note_SelectAll]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_Note_SelectAll] 
AS
BEGIN
	select [dbo].[Notes].*,[dbo].[Users].Name as UserName
	from [dbo].[Notes] inner join [dbo].[Users]
	on [dbo].[Notes].UserGuid=[dbo].[Users].Guid
End
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Gardesh_SelectAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Gardesh_SelectAll]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_Gardesh_SelectAll] 
AS
BEGIN
	select * from [dbo].[GardeshHesabs]
End
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_PhoneBook_SelectAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_PhoneBook_SelectAll]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_PhoneBook_SelectAll] 
AS
BEGIN
	select * from [dbo].[PhoneBooks]
End
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_SmsLog_SelectAll]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_SmsLog_SelectAll]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_SmsLog_SelectAll] 
AS
BEGIN
	select [dbo].[SmsLogs].*,[dbo].[Users].Name As UserName
	from [dbo].[SmsLogs] inner join [dbo].[Users]
	on [dbo].[SmsLogs].UserGuid=[dbo].[Users].Guid
End
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Pardakht_Save]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Pardakht_Save]	As Begin print 11 end')
GO

ALTER PROCEDURE [dbo].[sp_Pardakht_Save]
	@guid uniqueidentifier,
	@modif datetime,
	@dateSh nvarchar(20),
	@st bit='true',
	@payer uniqueidentifier,
	@createdate datetime,
	@desc nvarchar(max)='',
	@naqdprice bigint=0,
	@bankprice bigint=0,
	@checkprice bigint=0,
	@fishNo nvarchar(50)='',
	@checkNo nvarchar(50)='',
	@sarresid nvarchar(50)='',
	@bankname nvarchar(50)=''
AS
BEGIN
	declare @gardeshprice bigint
	declare @totalPrice bigint
	declare @tarafHesab uniqueidentifier


	set @gardeshprice=(ISNULL((select Price from GardeshHesabs
		where ParentGuid=@guid and PeopleGuid=@payer),0))

	set @totalPrice=(@naqdprice+@bankprice+@checkprice)

	if(@gardeshprice<>0)
	begin
		update GardeshHesabs
		set Price=@totalPrice
		where ParentGuid=@guid and PeopleGuid=@payer
	end
	else
	begin
		insert into GardeshHesabs(Babat,Description,Guid,Modified,ParentGuid,PeopleGuid,Price,Status,Type)
		values(4,N' ثبت سند پرداخت در تاریخ'+@dateSh,NEWID(), GETDATE(),@guid,@payer,@totalPrice,'true',2)
	end

	set @tarafHesab=(ISNULL((select Guid from Peoples
		where Guid=@payer),'00000000-0000-0000-0000-000000000000'))

	if (@tarafHesab='00000000-0000-0000-0000-000000000000')
	begin
		set @tarafHesab=(ISNULL((select Guid from Users
		where Guid=@payer),'00000000-0000-0000-0000-000000000000'))

		if(@tarafHesab='00000000-0000-0000-0000-000000000000')
		begin
			set @tarafHesab=(ISNULL((select Guid from Hazines
			where Guid=@payer),'00000000-0000-0000-0000-000000000000'))

			update Hazines
			set Account=Account-@gardeshprice
			where Guid=@payer

			update Hazines
			set Account=Account+@totalPrice
			where Guid=@payer
		end
		else
		begin
			update Users
			set Account=Account-@gardeshprice
			where Guid=@payer

			update Users
			set Account=Account+@totalPrice
			where Guid=@payer
		end
	end
	else
	begin
		    update Peoples
			set Account=Account-@gardeshprice
			where Guid=@payer

			update Peoples
			set Account=Account+@totalPrice
			where Guid=@payer
	end

	update Pardakhts
	set Modified=@modif,
	Status=@st,
	Payer=@payer,
	NaqdPrice=@naqdprice,
	BankPrice=@bankprice,
	[Check]=@checkprice,
	Description=@desc,
	FishNo=@fishNo,
	CheckNo=@checkNo,
	SarResid=@sarresid,
	BankName=@bankname
	where Guid=@guid

	if (@@ROWCOUNT=0)
	begin
		insert into Pardakhts(BankName,BankPrice,[Check],CheckNo,CreateDate,Description,FishNo,Guid,Modified,NaqdPrice,Payer,SarResid,Status)
		values(@bankname,@bankprice,@checkprice,@checkNo,GETDATE(),@desc,@fishNo,@guid,GETDATE(),@naqdprice,@payer,@sarresid,@st)
	end
END
GO
-- ==========================================================================================
IF Not EXISTS (SELECT * FROM dbo.sysobjects WHERE id = OBJECT_ID(N'[sp_Reception_Save]') AND OBJECTPROPERTY(id, N'IsProcedure') = 1)
	exec('Create Procedure [dbo].[sp_Reception_Save]	As Begin print 11 end')
GO
Alter PROCEDURE [dbo].[sp_Reception_Save]
	@guid uniqueidentifier,
	@modif datetime,
	@dateSh nvarchar(20),
	@st bit='true',
	@receptor uniqueidentifier,
	@createdate datetime,
	@desc nvarchar(max)='',
	@naqdprice bigint=0,
	@bankprice bigint=0,
	@checkprice bigint=0,
	@fishNo nvarchar(50)='',
	@checkNo nvarchar(50)='',
	@sarresid nvarchar(50)='',
	@bankname nvarchar(50)=''
AS
BEGIN
	declare @gardeshprice bigint
	declare @totalPrice bigint
	declare @tarafHesab uniqueidentifier


	set @gardeshprice=(ISNULL((select Price from GardeshHesabs
		where ParentGuid=@guid and PeopleGuid=@receptor),0))

	set @totalPrice=(@naqdprice+@bankprice+@checkprice)

	if(@gardeshprice<>0)
	begin
		update GardeshHesabs
		set Price=@totalPrice
		where ParentGuid=@guid and PeopleGuid=@receptor
	end
	else
	begin
		insert into GardeshHesabs(Babat,Description,Guid,Modified,ParentGuid,PeopleGuid,Price,Status,Type)
		values(3,N' ثبت سند دریافت در تاریخ'+@dateSh,NEWID(), GETDATE(),@guid,@receptor,@totalPrice,'true',3)
	end

	set @tarafHesab=(ISNULL((select Guid from Peoples
		where Guid=@receptor),'00000000-0000-0000-0000-000000000000'))

	if (@tarafHesab='00000000-0000-0000-0000-000000000000')
	begin
		set @tarafHesab=(ISNULL((select Guid from Users
		where Guid=@receptor),'00000000-0000-0000-0000-000000000000'))

		update Users
		set Account=Account+@gardeshprice
		where Guid=@receptor

		update Users
		set Account=Account-@totalPrice
		where Guid=@receptor
	end
	else
	begin
		update Peoples
		set Account=Account+@gardeshprice
		where Guid=@receptor

		update Peoples
		set Account=Account-@totalPrice
		where Guid=@receptor
	end

	update Receptions
	set Modified=@modif,
	Status=@st,
	Receptor=@receptor,
	NaqdPrice=@naqdprice,
	BankPrice=@bankprice,
	[Check]=@checkprice,
	Description=@desc,
	FishNo=@fishNo,
	CheckNo=@checkNo,
	SarResid=@sarresid,
	BankName=@bankname
	where Guid=@guid

	if (@@ROWCOUNT=0)
	begin
		insert into Receptions(BankName,BankPrice,[Check],CheckNo,CreateDate,Description,FishNo,Guid,Modified,NaqdPrice,Receptor,SarResid,Status)
		values(@bankname,@bankprice,@checkprice,@checkNo,GETDATE(),@desc,@fishNo,@guid,GETDATE(),@naqdprice,@receptor,@sarresid,@st)
	end
END